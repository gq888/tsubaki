<template>
  <div class="game-layout-container">
    <!-- ÂàáÊç¢ÊåâÈíÆ -->
    <button
      class="toggle-header-btn"
      @click="toggleHeader"
      @mouseleave="handleMouseLeave"
      @touchstart="startLongPress"
      @touchend="stopLongPress"
      @touchcancel="stopLongPress"
      @mouseenter="handleMouseEnter"
      :title="isHeaderExpanded ? 'Êî∂Ëµ∑ÂØºËà™ÂíåÊ†áÈ¢ò' : 'Â±ïÂºÄÂØºËà™ÂíåÊ†áÈ¢ò'"
    >
      {{ isHeaderExpanded ? "‚ñ≤" : "‚ñº" }}
    </button>

    <!-- ËÆæÁΩÆÊåâÈíÆ -->
    <button
      class="settings-btn"
      @click="openSettings"
      title="Ê∏∏ÊàèËÆæÁΩÆ"
    >
      ‚öôÔ∏è
    </button>

    <!-- Â∏ÆÂä©ÊåâÈíÆ -->
    <button
      class="help-btn"
      @click="openHelp"
      title="Ê∏∏ÊàèÂ∏ÆÂä©"
    >
      ‚ùì
    </button>

    <!-- ËÆæÁΩÆÂºπÁ™ó -->
    <GameSettings
      :visible="showSettings"
      :currentGame="currentGameName"
      @close="closeSettings"
      @settings-saved="handleSettingsSaved"
      ref="gameSettings"
    />

    <!-- Â∏ÆÂä©ÂºπÁ™ó -->
    <div v-if="showHelp" class="help-modal" @click="closeHelp">
      <div class="help-content" @click.stop>
        <h3>GUIDE</h3>
        <div class="button-help-list">
          <div v-for="(btn, index) in helpContent" :key="index" class="button-help-item">
            <span class="button-label">{{ btn.label }}</span>
            <span class="button-description">{{ btn.description }}</span>
          </div>
        </div>
        <button class="close-btn" @click="closeHelp">CLOSE</button>
      </div>
    </div>

    <!-- Fixed ÂØºËà™Ê†è -->
    <transition name="slide-down">
      <div v-show="isHeaderExpanded" ref="gameNav" class="game-nav">
        <template v-for="nav in navItems" :key="nav.path">
          <router-link :to="nav.path">{{ nav.icon + ($route.path === nav.path ? title : "") }}</router-link>
          <!-- <span v-if="$route.path === nav.path" class="nav-title">{{ title }}</span> -->
        </template>
      </div>
    </transition>

    <!-- Fixed Ê†áÈ¢òÂíåÈ°∂ÈÉ®ÊéßÂà∂Âå∫ -->
    <transition name="slide-down">
      <div
        v-show="isHeaderExpanded"
        ref="gameHeader"
        class="game-header"
        :style="{ top: navHeight / 16 + 'rem' }"
      >
        <!-- È°∂ÈÉ®ÊéßÂà∂ÊåâÈíÆÊèíÊßΩ -->
        <slot name="top-controls">
          <GameControls
            v-if="showTopControls"
            v-bind="gameControlsConfig"
            @undo="$emit('undo')"
            @goon="$emit('goon')"
            @step="$emit('step')"
            @auto="$emit('auto')"
            ref="gameControls"
          />
        </slot>
      </div>
    </transition>

    <!-- ÂèØÊªöÂä®ÁöÑÊ∏∏ÊàèÂÜÖÂÆπÂå∫Âüü -->
    <div class="game-content-wrapper" :style="contentWrapperStyle">
      <slot name="game-content"></slot>
    </div>

    <!-- Fixed Â∫ïÈÉ®ÊéßÂà∂ÊåâÈíÆ -->
    <div
      ref="gameFooter"
      class="game-footer"
      v-if="showBottomControls || $slots['bottom-controls']"
    >
      <slot name="bottom-controls">
        <GameControls
            v-if="showBottomControls"
            v-bind="gameControlsConfig"
            @undo="$emit('undo')"
            @goon="$emit('goon')"
            @step="$emit('step')"
            @auto="$emit('auto')"
            ref="bottomGameControls"
          />
      </slot>
    </div>

    <!-- Ê∏∏ÊàèÁªìÊûúÊ®°ÊÄÅÊ°ÜÊèíÊßΩ -->
    <slot name="result-modals">
      <!-- Win Modal -->
      <GameResultModal
        v-if="winflag"
        :title="winTitle !== undefined ? winTitle : 'U WIN!'"
        :subtitle="winSubtitle"
        :buttons="winButtons || defaultWinButtons"
        :modalStyle="winModalStyle"
        :customClass="winCustomClass"
      >
        <template v-if="$slots['win-content']" v-slot:content>
          <slot name="win-content"></slot>
        </template>
        <template v-if="$slots['win-cards']" v-slot:cards>
          <slot name="win-cards"></slot>
        </template>
      </GameResultModal>

      <!-- Lose Modal -->
      <GameResultModal
        v-if="loseflag"
        :title="loseTitle !== undefined ? loseTitle : 'U LOSE'"
        :subtitle="loseSubtitle"
        :buttons="loseButtons || defaultLoseButtons"
        :modalStyle="loseModalStyle || { backgroundColor: 'rgba(0,0,0,0.5)' }"
        :customClass="loseCustomClass"
      >
        <template v-if="$slots['lose-content']" v-slot:content>
          <slot name="lose-content"></slot>
        </template>
        <template v-if="$slots['lose-cards']" v-slot:cards>
          <slot name="lose-cards"></slot>
        </template>
      </GameResultModal>

      <!-- Draw Modal -->
      <GameResultModal
        v-if="drawflag"
        :title="drawTitle !== undefined ? drawTitle : 'DRAW GAME'"
        :subtitle="drawSubtitle"
        :buttons="drawButtons || defaultDrawButtons"
        :modalStyle="drawModalStyle || { backgroundColor: 'rgba(0,0,0,0.5)' }"
        :customClass="drawCustomClass"
      >
        <template v-if="$slots['draw-content']" v-slot:content>
          <slot name="draw-content"></slot>
        </template>
        <template v-if="$slots['draw-cards']" v-slot:cards>
          <slot name="draw-cards"></slot>
        </template>
      </GameResultModal>
    </slot>
  </div>
</template>

<script>
import GameControls from "./GameControls.vue";
import GameResultModal from "./GameResultModal.vue";
import GameSettings from "./GameSettings.vue";
import eventBus from "../utils/eventBus.js";

export default {
  name: "GameLayout",
  components: {
    GameControls,
    GameResultModal,
    GameSettings,
  },
  data() {
    return {
      isHeaderExpanded: true,
      navHeight: 0,
      headerHeight: 0,
      footerHeight: 0,
      resizeObserver: null,
      lastScrollTop: 0,
      lastToggleTime: 0, // ‰∏äÊ¨°ÂàáÊç¢ÁöÑÊó∂Èó¥Êà≥
      toggleCooldown: 500, // ÂàáÊç¢ÂÜ∑Âç¥Êó∂Èó¥ÔºàÊØ´ÁßíÔºâ
      autoHideTimer: null, // Ëá™Âä®ÈöêËóèÂÆöÊó∂Âô®
      showSettings: false, // ÊòØÂê¶ÊòæÁ§∫ËÆæÁΩÆÂºπÁ™ó
      showHelp: false, // ÊòØÂê¶ÊòæÁ§∫Â∏ÆÂä©ÂºπÁ™ó
      helpContent: [], // Â∏ÆÂä©ÂÜÖÂÆπ
      gameControlsButtons: {}, // Â≠òÂÇ®ÊâÄÊúâGameControlsÁªÑ‰ª∂ÁöÑÊåâÈíÆÈÖçÁΩÆ
      longPressTimer: null, // ÈïøÊåâÂÆöÊó∂Âô®
      isLongPress: false, // ÊòØÂê¶Ê≠£Âú®ÈïøÊåâ
      isHovered: false, // ÊòØÂê¶Ê≠£Âú®ÊÇ¨ÂÅú
      longPressDuration: 500, // ÈïøÊåâÂà§ÂÆöÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
      navItems: [
        { path: '/month', icon: 'üåõ' },
        { path: '/fish', icon: 'üêü' },
        { path: '/blackjack', icon: '‚ô†Ô∏è' },
        { path: '/point24', icon: '24' },
        { path: '/Tortoise', icon: 'üê¢' },
        { path: '/Sort', icon: 'üêó' },
        { path: '/Pairs', icon: 'üê∞' },
        { path: '/Spider', icon: 'üï∑Ô∏è' },
        { path: '/GridBattle', icon: '‚öîÔ∏è' },
      ],
    };
  },
  props: {
    // Âü∫Á°ÄÂ±ûÊÄß
    title: {
      type: String,
      default: "",
    },
    containerStyle: {
      type: Object,
      default: () => ({ width: "100%" }),
    },
    // Ê∏∏ÊàèËßÑÂàôËØ¥Êòé
    gameRule: {
      type: String,
      default: "",
    },

    // ÊéßÂà∂ÊåâÈíÆÁõ∏ÂÖ≥
    showTopControls: {
      type: Boolean,
      default: false,
    },
    showBottomControls: {
      type: Boolean,
      default: true,
    },
    gameControlsConfig: {
      type: Object,
      default: () => ({}),
    },

    // Ê∏∏ÊàèÁä∂ÊÄÅÊ†áÂøó
    winflag: {
      type: Boolean,
      default: false,
    },
    loseflag: {
      type: Boolean,
      default: false,
    },
    drawflag: {
      type: Boolean,
      default: false,
    },

    // Win Modal ÈÖçÁΩÆ
    winTitle: String,
    winSubtitle: String,
    winButtons: Array,
    winModalStyle: Object,
    winCustomClass: String,

    // Lose Modal ÈÖçÁΩÆ
    loseTitle: String,
    loseSubtitle: String,
    loseButtons: Array,
    loseModalStyle: Object,
    loseCustomClass: String,

    // Draw Modal ÈÖçÁΩÆ
    drawTitle: String,
    drawSubtitle: String,
    drawButtons: Array,
    drawModalStyle: Object,
    drawCustomClass: String,

    // ÂÖ∂‰ªñÊ∏∏ÊàèÁõ∏ÂÖ≥Â±ûÊÄß
    step: {
      type: Number,
      default: 0,
    },
    
    // Êô∫ËÉΩÊªöÂä®ÈÖçÁΩÆ
    enableSmartScroll: {
      type: Boolean,
      default: true,
    },
    smartScrollThreshold: {
      type: Number,
      default: 50,
    },
    autoHideDelay: {
      type: Number,
      default: 2000, // ÈªòËÆ§4ÁßíÂêéËá™Âä®ÈöêËóè
    },
  },
  computed: {
    contentWrapperStyle() {
      const topPadding = this.navHeight + this.headerHeight;
      const bottomPadding = this.footerHeight;

      return {
        ...this.containerStyle,
        paddingTop: `${topPadding / 16}rem`,
        paddingBottom: `${bottomPadding / 16}rem`,
      };
    },
    defaultWinButtons() {
      return [
        {
          text: "GO ON",
          callback: () => this.$emit("goon"),
          disabled: false,
        },
      ];
    },
    defaultLoseButtons() {
      return [
        {
          text: "RESTART",
          callback: () => this.$emit("goon"),
          disabled: false,
        },
        {
          text: "UNDO",
          callback: () => this.$emit("undo"),
          disabled: this.step <= 0,
        },
      ];
    },
    defaultDrawButtons() {
      return [
        {
          text: "RESTART",
          callback: () => this.$emit("goon"),
          disabled: false,
        },
        {
          text: "UNDO",
          callback: () => this.$emit("undo"),
          disabled: this.step <= 0,
        },
      ];
    },
    currentGameName() {
      // ‰ªéË∑ØÁî±‰∏≠Ëé∑ÂèñÂΩìÂâçÊ∏∏ÊàèÂêçÁß∞
      return this.$route?.path?.substring(1) || '';
    },
  },
  mounted() {
    this.updateHeights();
    this.setupResizeObserver();
    this.setupScrollListener();
    this.startAutoHideTimer();
    
    // ÁõëÂê¨‰∫ã‰ª∂ÊÄªÁ∫ø‰∏≠ÁöÑGameControlsÁõ∏ÂÖ≥‰∫ã‰ª∂
    eventBus.on('game-controls:mounted', this.handleControlsMounted);
    eventBus.on('game-controls:buttons-updated', this.handleControlsButtonsUpdated);
    eventBus.on('game-controls:unmounted', this.handleControlsUnmounted);
    
    // Ëß¶Âèë‰∏ÄÊ¨°ËØ∑Ê±ÇÔºåËÆ©Â∑≤Â≠òÂú®ÁöÑGameControlsÁªÑ‰ª∂Êõ¥Êñ∞ÈÖçÁΩÆ
    setTimeout(() => {
      eventBus.emit('game-layout:request-update');
      
      // Ê£ÄÊü•ÊòØÂê¶È¶ñÊ¨°ËÆøÈóÆËØ•Ê∏∏ÊàèÔºåÂ¶ÇÊûúÊòØÂàôÊâìÂºÄÂ∏ÆÂä©ÂºπÁ™ó
      const currentGame = this.currentGameName;
      if (currentGame) {
        const visitedKey = `game-visited-${currentGame}`;
        if (!localStorage.getItem(visitedKey)) {
          console.log('È¶ñÊ¨°ËÆøÈóÆÊ∏∏ÊàèÔºåÊòæÁ§∫Â∏ÆÂä©ÂºπÁ™ó');
          setTimeout(() => {
            this.openHelp();
            this.$refs.gameSettings.recordGameVisit();
          }, 500); // Âª∂ËøüÊâìÂºÄÔºåÁ°Æ‰øùÁªÑ‰ª∂ÂÆåÂÖ®ÂàùÂßãÂåñ
        }
      }
    }, 100);
  },
  beforeUnmount() {
    // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨
    eventBus.off('game-controls:mounted', this.handleControlsMounted);
    eventBus.off('game-controls:buttons-updated', this.handleControlsButtonsUpdated);
    eventBus.off('game-controls:unmounted', this.handleControlsUnmounted);
    
    // Ê∏ÖÁêÜÂÖ∂‰ªñËµÑÊ∫ê
    if (this.resizeObserver) {
      this.resizeObserver.disconnect();
    }
    this.removeScrollListener();
    this.clearAutoHideTimer();
    this.clearLongPressTimer();
  },
  methods: {
    toggleHeader() {
      if (this.isHeaderExpanded) {
        this.collapseHeader();
      } else {
        this.expandHeader();
      }
    },
    updateHeights() {
      this.$nextTick(() => {
        if (this.$refs.gameNav) {
          this.navHeight = this.$refs.gameNav.offsetHeight;
        }
        if (this.$refs.gameHeader) {
          this.headerHeight = this.$refs.gameHeader.offsetHeight;
        }
        if (this.$refs.gameFooter) {
          this.footerHeight = this.$refs.gameFooter.offsetHeight;
        }
      });
    },
    setupResizeObserver() {
      if (typeof ResizeObserver === "undefined") return;

      this.resizeObserver = new ResizeObserver(() => {
        this.updateHeights();
      });

      this.$nextTick(() => {
        if (this.$refs.gameNav) {
          this.resizeObserver.observe(this.$refs.gameNav);
        }
        if (this.$refs.gameHeader) {
          this.resizeObserver.observe(this.$refs.gameHeader);
        }
        if (this.$refs.gameFooter) {
          this.resizeObserver.observe(this.$refs.gameFooter);
        }
      });
    },
    /**
     * ËÆæÁΩÆÊªöÂä®ÁõëÂê¨Âô®
     * ÂÆûÁé∞Êô∫ËÉΩÂ§¥ÈÉ®ÊòæÁ§∫/ÈöêËóèÔºö
     * - Âú®È°∂ÈÉ®ÁªßÁª≠Âêë‰∏äÊªöÂä® ‚Üí ÈöêËóèÂ§¥ÈÉ®ÔºàÈáäÊîæÁ©∫Èó¥Ôºâ
     * - Âú®Â∫ïÈÉ®ÁªßÁª≠Âêë‰∏ãÊªöÂä® ‚Üí Â±ïÂºÄÂ§¥ÈÉ®ÔºàÊòæÁ§∫ÊéßÂà∂Ôºâ
     */
    setupScrollListener() {
      this.$nextTick(() => {
        const wrapper = this.$el?.querySelector('.game-content-wrapper');
        if (wrapper) {
          this._scrollHandler = this.handleScroll.bind(this);
          wrapper.addEventListener('scroll', this._scrollHandler, { passive: true });
        }
      });
    },
    removeScrollListener() {
      const wrapper = this.$el?.querySelector('.game-content-wrapper');
      if (wrapper && this._scrollHandler) {
        wrapper.removeEventListener('scroll', this._scrollHandler);
      }
    },
    handleScroll(event) {
      // Â¶ÇÊûúÁ¶ÅÁî®‰∫ÜÊô∫ËÉΩÊªöÂä®ÔºåÁõ¥Êé•ËøîÂõû
      if (!this.enableSmartScroll) {
        return;
      }
      
      const wrapper = event.target;
      const scrollTop = wrapper.scrollTop;
      const scrollHeight = wrapper.scrollHeight;
      const clientHeight = wrapper.clientHeight;
      
      // ËÆ°ÁÆóÊªöÂä®ÊñπÂêëÔºàÈúÄË¶ÅÊúâÊòéÊòæÁöÑÊªöÂä®Ë∑ùÁ¶ªÊâçÁÆóÔºâ
      const scrollDelta = scrollTop - this.lastScrollTop;
      const scrollingDown = scrollDelta > 0;
      const scrollingUp = scrollDelta < 0;
      
      // Ê£ÄÊü•ÊòØÂê¶Âú®È°∂ÈÉ®ÔºàÂ∏¶ÈòàÂÄºÔºâ
      const isAtTop = scrollTop <= this.smartScrollThreshold;
      
      // Ê£ÄÊü•ÊòØÂê¶Âú®Â∫ïÈÉ®ÔºàÂ∏¶ÈòàÂÄºÔºâ
      const isAtBottom = scrollTop + clientHeight >= scrollHeight - this.smartScrollThreshold;
      
      // Ê£ÄÊü•ÂÜ∑Âç¥Êó∂Èó¥
      const now = Date.now();
      const canToggle = now - this.lastToggleTime >= this.toggleCooldown;
      
      // Êô∫ËÉΩÂàáÊç¢ÈÄªËæëÔºàÂ∏¶ÂÜ∑Âç¥Êó∂Èó¥Ôºâ
      if (canToggle) {
        if ((isAtTop && scrollingUp || isAtBottom && scrollingDown) && !this.isHeaderExpanded) {
          this.lastToggleTime = now;
          this.expandHeader();
        }
      }
      
      this.lastScrollTop = scrollTop;
    },
    
    expandHeader() {
      this.isHeaderExpanded = true;
      this.$nextTick(() => {
        this.updateHeights();
      });
      // Âè™ÊúâÂú®Ê≤°ÊúâÈïøÊåâÊàñÊÇ¨ÂÅúÊó∂ÊâçÂêØÂä®Ëá™Âä®ÈöêËóèÂÆöÊó∂Âô®
      if (!this.isLongPress && !this.isHovered) {
        this.startAutoHideTimer();
      }
    },
    
    collapseHeader() {
      // Âè™ÊúâÂú®Ê≤°ÊúâÈïøÊåâÊàñÊÇ¨ÂÅúÊó∂ÊâçÂÖÅËÆ∏Êî∂Ëµ∑
      if (!this.isLongPress && !this.isHovered) {
        this.isHeaderExpanded = false;
        this.$nextTick(() => {
          this.updateHeights();
        });
        // ÈöêËóèÂ§¥ÈÉ®Êó∂Ê∏ÖÈô§ÂÆöÊó∂Âô®
        this.clearAutoHideTimer();
      }
    },
    
    startAutoHideTimer() {
      this.clearAutoHideTimer();
      // Âè™ÊúâÂú®Ê≤°ÊúâÈïøÊåâÊàñÊÇ¨ÂÅúÊó∂ÊâçËÆæÁΩÆËá™Âä®ÈöêËóè
      if (!this.isLongPress && !this.isHovered) {
        this.autoHideTimer = setTimeout(() => {
          this.collapseHeader();
        }, this.autoHideDelay);
      }
    },
    
    clearAutoHideTimer() {
      if (this.autoHideTimer) {
        clearTimeout(this.autoHideTimer);
        this.autoHideTimer = null;
      }
    },
    
    // ÂºÄÂßãÈïøÊåâÊ£ÄÊµã
    startLongPress() {
      this.isLongPress = false;
      this.clearLongPressTimer();
      this.longPressTimer = setTimeout(() => {
        this.isLongPress = true;
        // ÈïøÊåâÊúüÈó¥Â±ïÂºÄÂØºËà™Âπ∂Èò≤Ê≠¢Ëá™Âä®Êî∂Ëµ∑
        this.expandHeader();
        this.clearAutoHideTimer();
      }, this.longPressDuration);
    },
    
    // ÂÅúÊ≠¢ÈïøÊåâÊ£ÄÊµã
    stopLongPress() {
      this.clearLongPressTimer();
      this.isLongPress = false;
      // Â¶ÇÊûúÂØºËà™ÊòØÂ±ïÂºÄÁöÑÔºåÈáçÊñ∞ËÆæÁΩÆËá™Âä®ÈöêËóèÔºàÂ¶ÇÊûúÊ≤°ÊúâÊÇ¨ÂÅúÔºâ
      if (this.isHeaderExpanded && !this.isHovered) {
        this.startAutoHideTimer();
      }
    },
    
    // Ê∏ÖÈô§ÈïøÊåâÂÆöÊó∂Âô®
    clearLongPressTimer() {
      if (this.longPressTimer) {
        clearTimeout(this.longPressTimer);
        this.longPressTimer = null;
      }
    },
    
    // Â§ÑÁêÜÈº†Ê†áÊÇ¨ÂÅú
    handleMouseEnter() {
      this.isHovered = true;
      // ÊÇ¨ÂÅúÊó∂Â±ïÂºÄÂØºËà™Âπ∂Èò≤Ê≠¢Ëá™Âä®Êî∂Ëµ∑
      this.expandHeader();
      this.clearAutoHideTimer();
    },
    
    // Â§ÑÁêÜÈº†Ê†áÁ¶ªÂºÄ
    handleMouseLeave() {
      this.isHovered = false;
      this.stopLongPress(); // Á°Æ‰øùÈïøÊåâÁä∂ÊÄÅ‰πüË¢´Ê≠£Á°ÆÊ∏ÖÈô§
      // Èº†Ê†áÁ¶ªÂºÄÂêéÔºåÈáçÊñ∞ËÆæÁΩÆËá™Âä®ÈöêËóè
      if (this.isHeaderExpanded) {
        this.startAutoHideTimer();
      }
    },
    
    openSettings() {
      this.showSettings = true;
    },
    
    closeSettings() {
      this.showSettings = false;
    },
    
    // Â§ÑÁêÜGameControlsÁªÑ‰ª∂ÊåÇËΩΩ‰∫ã‰ª∂
    handleControlsMounted(data) {
      this.gameControlsButtons[data.instanceId] = data.buttons;
    },
    
    // Â§ÑÁêÜGameControlsÁªÑ‰ª∂ÊåâÈíÆÊõ¥Êñ∞‰∫ã‰ª∂
    handleControlsButtonsUpdated(data) {
      this.gameControlsButtons[data.instanceId] = data.buttons;
    },
    
    // Â§ÑÁêÜGameControlsÁªÑ‰ª∂Âç∏ËΩΩ‰∫ã‰ª∂
    handleControlsUnmounted(data) {
      delete this.gameControlsButtons[data.instanceId];
    },
    
    // ÊâìÂºÄÂ∏ÆÂä©ÂºπÁ™ó
    openHelp() {
      // ÊåâÈíÆËØ¥ÊòéÊò†Â∞Ñ
      const buttonDescriptions = {
        undo: "CANCEL THE LAST MOVE",
        goon: "RESTART THE GAME",
        restart: "RESTART THE GAME",
        hint: "GET A HINT",
        step: "EXECUTE THE NEXT MOVE",
        auto: "AUTO EXECUTE/STOP AUTO EXECUTE",
        hitBtn: "DRAW A NEW CARD",
        passBtn: "STOP DRAWING CARDS"
      };
      
      // Êî∂ÈõÜÊâÄÊúâGameControlsÂÆû‰æãÁöÑÊåâÈíÆÈÖçÁΩÆ
      const uniqueButtons = new Map();
      
      // ‰ªé‰∫ã‰ª∂ÊÄªÁ∫øÊî∂ÈõÜÁöÑÊåâÈíÆÈÖçÁΩÆÔºà‰ºòÂÖà‰ΩøÁî®Ôºâ
      Object.values(this.gameControlsButtons).forEach(buttons => {
        if (buttons && Array.isArray(buttons)) {
          buttons.forEach(button => {
            if (button.action) {
              uniqueButtons.set(button.action, button);
            }
          });
        }
      });
      
      // ÂêåÊó∂‰πüÊ£ÄÊü•ÂëΩÂêçÁöÑrefs‰Ωú‰∏∫Â§áÁî®
      if (this.$refs.gameControls && this.$refs.gameControls.displayButtons) {
        this.$refs.gameControls.displayButtons.forEach(button => {
          if (button.action && !uniqueButtons.has(button.action)) {
            uniqueButtons.set(button.action, button);
          }
        });
      }
      
      if (this.$refs.bottomGameControls && this.$refs.bottomGameControls.displayButtons) {
        this.$refs.bottomGameControls.displayButtons.forEach(button => {
          if (button.action && !uniqueButtons.has(button.action)) {
            uniqueButtons.set(button.action, button);
          }
        });
      }
      
      // ÂàùÂßãÂåñÂ∏ÆÂä©ÂÜÖÂÆπ
      this.helpContent = [];
      
      // Ê∑ªÂä†Ê∏∏ÊàèËßÑÂàôËØ¥ÊòéÔºà‰Ωú‰∏∫‰∏Ä‰∏™ÁâπÊÆäÁöÑÂ∏ÆÂä©È°πÔºâ
      if (this.gameRule) {
        this.helpContent.push({
          label: "üìã",
          description: `RULE: ${this.gameRule}`
        });
      }
      
      // Ê∑ªÂä†ÊåâÈíÆÊìç‰ΩúËØ¥Êòé
      if (uniqueButtons.size > 0) {
        console.log("ÈÄöËøá‰∫ã‰ª∂ÊÄªÁ∫øËé∑ÂèñÂà∞ÁöÑÊåâÈíÆÈÖçÁΩÆ:", Array.from(uniqueButtons.values()));
        // ‰ªéMapËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂Ê∑ªÂä†Âà∞Â∏ÆÂä©ÂÜÖÂÆπ‰∏≠
        const buttonItems = Array.from(uniqueButtons.values()).map(button => ({
          label: button.label || button.action.toUpperCase(),
          description: buttonDescriptions[button.action] || 'Êú™Áü•ÂäüËÉΩ'
        }));
        this.helpContent.push(...buttonItems);
      } else {
        console.log("Êú™Ëé∑ÂèñÂà∞Ê∏∏ÊàèÊåâÈíÆÈÖçÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§ÊåâÈíÆËØ¥Êòé");
        // Â¶ÇÊûúÊó†Ê≥ïÁõ¥Êé•Ëé∑ÂèñÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑÊåâÈíÆËØ¥Êòé
        const defaultButtonItems = [
          { label: "‚óÄÔ∏é", description: buttonDescriptions.undo },
          { label: "RESTART", description: buttonDescriptions.restart },
          { label: "AUTO/STOP", description: buttonDescriptions.auto },
          { label: "‚ñ∫", description: buttonDescriptions.step }
        ];
        this.helpContent.push(...defaultButtonItems);
      }
      
      this.showHelp = true;
    },
    
    // ÂÖ≥Èó≠Â∏ÆÂä©ÂºπÁ™ó
    closeHelp() {
      this.showHelp = false;
    },
    
    handleSettingsSaved(settings) {
      // ÂèëÈÄÅËÆæÁΩÆ‰øùÂ≠ò‰∫ã‰ª∂ÁªôÁà∂ÁªÑ‰ª∂
      this.$emit('settings-changed', settings);
    },
  },
  emits: ["undo", "goon", "step", "auto", "settings-changed"],
};
</script>

<style scoped>
@import url("./sum.css");

/* Â∏ÉÂ±ÄÂÆπÂô® */
.game-layout-container {
  width: 100%;
  height: 100vh;
  overflow: hidden;
}

/* Fixed ÂØºËà™Ê†è */
.game-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  padding: 0.5rem 1rem;
  background: #fff;
  border-bottom: 0.0625rem solid #e0e0e0;
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.game-nav a {
  font-weight: bold;
  color: #2c3e50;
  text-decoration: none;
  padding: 0.25rem 0.5rem;
  border-radius: 0.375rem;
  transition: all 0.2s ease;
  font-size: 1.125rem;
}

.game-nav a:hover {
  background: #f5f5f5;
  transform: scale(1.1);
}

.game-nav a.router-link-exact-active {
  color: #42b983;
  background: #e8f5f0;
}

/* Fixed Ê†áÈ¢òÂíåÈ°∂ÈÉ®ÊéßÂà∂Âå∫ */
.game-header {
  position: fixed;
  left: 0;
  right: 0;
  background: #fff;
  z-index: 999;
  text-align: center;
  border-bottom: 0.0625rem solid #f0f0f0;
  transition: top 0.3s ease;
}

/* ÂàáÊç¢ÊåâÈíÆ */
.toggle-header-btn {
  position: fixed;
  top: 0.5rem;
  left: 0.5rem;
  width: 1.75rem;
  height: 1.75rem;
  border-radius: 50%;
  background: #42b983;
  color: white;
  border: none;
  cursor: pointer;
  z-index: 1001;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

.toggle-header-btn:hover {
  background: #35a372;
  transform: scale(1.1);
}

/* ÈïøÊåâÊàñËß¶Êë∏Êó∂ÁöÑÊ†∑ÂºèÂ¢ûÂº∫ */
.toggle-header-btn:active {
  background: #2a8a61;
  transform: scale(0.95);
}

/* ËÆæÁΩÆÊåâÈíÆ */
.settings-btn {
  position: fixed;
  top: 0.5rem;
  right: 0.5rem;
  width: 1.75rem;
  height: 1.75rem;
  border-radius: 50%;
  background: #42b983;
  color: white;
  border: none;
  cursor: pointer;
  z-index: 1001;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

.settings-btn:hover {
  background: #35a372;
  transform: scale(1.1) rotate(90deg);
}

.settings-btn:active {
  transform: scale(0.95);
}

/* Â∏ÆÂä©ÊåâÈíÆ */
.help-btn {
  position: fixed;
  top: 3rem;
  right: 0.5rem;
  width: 1.75rem;
  height: 1.75rem;
  border-radius: 50%;
  background: #42b983;
  color: white;
  border: none;
  cursor: pointer;
  z-index: 1001;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

.help-btn:hover {
  background: #35a372;
  transform: scale(1.1);
}

.help-btn:active {
  transform: scale(0.95);
}

/* Â∏ÆÂä©ÂºπÁ™óÊ†∑Âºè */
.help-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.help-content {
  background: white;
  padding: 1.5rem;
  border-radius: 0.5rem;
  max-width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
}

.help-content span {
  font-size: medium;
}

.help-content h3 {
  margin-top: 0;
  color: #2c3e50;
  text-align: center;
}

.button-help-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin: 1rem 0;
}

.button-help-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: #f8f9fa;
  border-radius: 0.375rem;
  border: 0.0625rem solid #e9ecef;
}

.button-label {
  padding: 0.25rem 0.5rem;
  background: #dfcdc3;
  border-radius: 0.25rem;
  min-width: 3rem;
  text-align: center;
  color: #2c3e50;
}

.button-description {
  flex: 1;
  color: #495057;
}

.close-btn {
  display: block;
  margin: 1rem auto 0;
  padding: 0.5rem 1rem;
  background: #42b983;
  color: white;
  border: none;
  border-radius: 0.375rem;
  cursor: pointer;
  transition: background 0.3s ease;
}

.close-btn:hover {
  background: #35a372;
}

/* ÂèØÊªöÂä®ÁöÑÊ∏∏ÊàèÂÜÖÂÆπÂå∫Âüü */
.game-content-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  overflow-x: hidden;
  transition: padding 0.3s ease;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch; /* ÁßªÂä®Á´ØÊµÅÁïÖÊªöÂä® */
  background-color: #3c4245;
}

/* Fixed Â∫ïÈÉ®ÊéßÂà∂Âå∫ */
.game-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 0.5rem;
  z-index: 999;
  text-align: center;
}

/* Âä®ÁîªÊïàÊûú */
.slide-down-enter-active,
.slide-down-leave-active {
  transition: all 0.3s ease;
}

.slide-down-enter-from {
  opacity: 0;
  transform: translateY(-1.25rem);
}

.slide-down-leave-to {
  opacity: 0;
  transform: translateY(-1.25rem);
}
</style>
